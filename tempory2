CLASS lhc_location DEFINITION INHERITING FROM cl_abap_behavior_handler.
  PRIVATE SECTION.

    METHODS DeterminationForChangedRecord FOR DETERMINATION location~DeterminationForChangedRecord
      IMPORTING keys FOR location.

    METHODS DeterminationForNewRecord FOR DETERMINATION location~DeterminationForNewRecord
      IMPORTING keys FOR location.


    METHODS get_features FOR FEATURES
      IMPORTING keys REQUEST requested_features FOR location RESULT result.

ENDCLASS.

CLASS lhc_location IMPLEMENTATION.



  METHOD DeterminationForChangedRecord.

    GET TIME STAMP FIELD DATA(lv_timestamp).

    READ ENTITIES OF z00bb_cds_location IN LOCAL MODE
        ENTITY location
         FIELDS ( locationid )
         WITH CORRESPONDING #(  keys )
        RESULT DATA(lt_location).

    LOOP AT lt_location INTO DATA(ls_location).
      ls_location-changedat = lv_timestamp.
      ls_location-changedby = sy-uname.
      MODIFY lt_location FROM ls_location.
    ENDLOOP.

    MODIFY ENTITIES OF z00bb_cds_location
              ENTITY location
                     UPDATE FROM VALUE #( FOR location IN lt_location (
                       locationid            = location-locationid
                       %control-changedat    = if_abap_behv=>mk-on
                       %control-changedby    = if_abap_behv=>mk-on
    ) ) .


  ENDMETHOD.

  METHOD DeterminationForNewRecord.
    GET TIME STAMP FIELD DATA(lv_timestamp).

    READ ENTITIES OF z00bb_cds_location
        ENTITY location
         FIELDS ( locationid )
         WITH CORRESPONDING #(  keys )
        RESULT DATA(lt_location).

    DATA(lt_old) = lt_location[].
    LOOP AT lt_location INTO DATA(ls_location).
      IF ls_location-locationid = 0.
        SELECT MAX( locationid ) FROM zre_dt_location INTO @ls_location-locationid.
      ENDIF.

      ls_location-changedat = lv_timestamp.
      ls_location-changedby = sy-uname.
      ls_location-createdat = lv_timestamp.
      ls_location-createdby = sy-uname.

      MODIFY lt_location FROM ls_location.
    ENDLOOP.

    MODIFY ENTITIES OF z00bb_cds_location
              ENTITY location
                     DELETE FROM VALUE #( FOR location IN lt_old (
                       locationid               = location-locationid ) )
              ENTITY location
                     CREATE FROM VALUE #( FOR location IN lt_location (
                       locationid               = location-locationid
                       %control-locationid    = if_abap_behv=>mk-on ) ) .

  ENDMETHOD.

  METHOD get_features.
  ENDMETHOD.

ENDCLASS.